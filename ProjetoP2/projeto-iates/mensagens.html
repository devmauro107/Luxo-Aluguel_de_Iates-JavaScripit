<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Mensagens Recebidas</title>
    <link rel="stylesheet" href="css/default.css">
</head>
<body>
        <h2>Mensagens Recebidas</h2>
    <table id="tabelaMensagens" border="1">
        <thead>
            <tr>
                <th>Nome</th>
                <th>Email</th>
                <th>Mensagem</th>
                <th>Ações</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <script src="js/jquery-3.6.4.min.js"></script>
    <script src="js/api.js"></script>
    <script>
        $(document).ready(function(){
            carregarMensagens();

        function carregarMensagens(){
            obterMensagens().then(function(mensagens){
            localStorage.setItem("mensagens", JSON.stringify(mensagens));
            montarTabela(mensagens);
            });
        }

    function montarTabela(mensagens){
        var tbody = $("#tabelaMensagens tbody");
            tbody.empty();

        mensagens.forEach(function(msg){
            var visualizadas = JSON.parse(localStorage.getItem("visualizadas")) || [];
            var isVisualizada = visualizadas.includes(msg.id);

            var estilo = isVisualizada ? "font-weight: normal;" : "font-weight: bold;";

            var linha = `
                <tr style="${estilo}">
                    <td>${msg.nome}</td>
                    <td>${msg.email}</td>
                    <td>${msg.mensagem}</td>
                    <td>
                        <button class="visualizar" data-id="${msg.id}">Visualizar</button>
                        <button class="excluir" data-id="${msg.id}">Excluir</button>
                    </td>
                </tr>
            `;
        tbody.append(linha);
    });

        $(".visualizar").click(function(){
            var id = $(this).data("id");
                if(confirm("Marcar como visualizada?")){
            var visualizadas = JSON.parse(localStorage.getItem("visualizadas")) || [];
                    if(!visualizadas.includes(id)){
                        visualizadas.push(id);
                localStorage.setItem("visualizadas", JSON.stringify(visualizadas));
            }
            carregarMensagens();
        }
    });

        $(".excluir").click(function(){
            var id = $(this).data("id");
                if(confirm("Deseja excluir esta mensagem?")){
                    excluirMensagem(id).then(function(){
                        alert("Mensagem excluída com sucesso!");
                    carregarMensagens();
                }).catch(function(){

                    alert("Erro ao excluir mensagem.");
                });
            }
        });
    }
});
</script>

</body>
</html>
